<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Produtos - Loja</title>

<style>
:root{--bg:linear-gradient(135deg,#00e1ff,#005eff);--glass:rgba(255,255,255,0.12);--accent:#00ffe0}
*{box-sizing:border-box}
body{margin:0;font-family:"Poppins",Arial,sans-serif;background:var(--bg);color:white;min-height:100vh}
header{padding:28px;text-align:center;background:rgba(0,0,0,0.35);backdrop-filter:blur(6px);font-size:24px;font-weight:700}
nav{background:rgba(0,0,0,0.35);backdrop-filter:blur(4px)}
nav ul{display:flex;justify-content:center;gap:10px;list-style:none;padding:10px;margin:0;flex-wrap:wrap}
nav a{color:white;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:600}
.container{width:92%;max-width:1200px;margin:34px auto}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
@media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,0.12);padding:12px;border-radius:12px;box-shadow:0 10px 30px #00000040;overflow:hidden;transition:transform .28s, box-shadow .28s}
.card:hover{transform:translateY(-8px);box-shadow:0 18px 40px #00000060}
.card .thumb{height:220px;width:100%;border-radius:8px;object-fit:cover;display:block;margin-bottom:12px;transition:transform .5s}
.card:hover .thumb{transform:scale(1.06)}
.card h3{margin:6px 0 8px 0}
.card .price{font-weight:800;font-size:18px;margin-bottom:8px}
.card .stock{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.2);font-weight:700;margin-bottom:8px}
.card .desc{margin-bottom:10px}
.btn-buy{display:inline-block;padding:10px 14px;background:var(--accent);color:#111;border-radius:10px;font-weight:800;text-decoration:none;cursor:pointer;border:none}
.btn-cart-link{display:inline-block;margin-left:12px;padding:8px 12px;background:rgba(255,255,255,0.12);color:white;border-radius:8px;text-decoration:none}
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px #00000080;display:none}
</style>
</head>
<body>

<header>üõí Nossa Loja</header>
<nav>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="quemsomos.html">Quem Somos</a></li>
    <li><a href="produtos.html">Produtos</a></li>
    <li><a href="sac.html">SAC</a></li>
    <li><a href="catalogo.html">Cat√°logo</a></li>
    <li><a href="admin.html">Administra√ß√£o</a></li>
    <li><a href="carrinho.html" class="btn-cart-link">Ver Carrinho</a></li>
  </ul>
</nav>

<div class="container">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;color:#fff;text-align:center;padding:20px">Ainda n√£o h√° produtos √† venda.</div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA1jqtL0w3-g8lMMdzqG6EZXYjYaadjOpE",
    authDomain: "loja-final-c7af0.firebaseapp.com",
    databaseURL: "https://loja-final-c7af0-default-rtdb.firebaseio.com",
    projectId: "loja-final-c7af0",
    storageBucket: "loja-final-c7af0.firebasestorage.app",
    messagingSenderId: "895657253198",
    appId: "1:895657253198:web:c0ec7d4c31482f1c26e61f",
    measurementId: "G-BHB81J2JD4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const produtosRef = ref(db, 'produtos');

  // cartId: persist in localStorage so same device keeps it
  function getCartId() {
    let id = localStorage.getItem('cartId');
    if (!id) {
      id = 'cart_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
      localStorage.setItem('cartId', id);
    }
    return id;
  }
  const cartId = getCartId();
  const cartRef = ref(db, 'carrinhos/' + cartId);

  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const toast = document.getElementById('toast');

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 2200);
  }

  onValue(produtosRef, (snap) => {
    grid.innerHTML = '';
    if (!snap.exists()) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';
    const data = snap.val();
    const entries = Object.entries(data).reverse();
    entries.forEach(([key,p]) => {
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='thumb'; img.src = p.img || 'https://via.placeholder.com/600x400?text=Sem+imagem';
      const h3 = document.createElement('h3'); h3.textContent = p.nome;
      const price = document.createElement('div'); price.className='price'; price.textContent = 'R$ ' + Number(p.preco).toFixed(2);
      const stock = document.createElement('div'); stock.className='stock'; stock.textContent = 'Estoque: ' + (p.estoque || 0);
      const desc = document.createElement('p'); desc.className='desc'; desc.textContent = p.descricao || '';

      const buy = document.createElement('button'); buy.className='btn-buy'; buy.textContent = 'Adicionar ao Carrinho';
      buy.addEventListener('click', async () => {
        // only add if stock > 0
        if (!p.estoque || Number(p.estoque) <= 0) { showToast('Produto esgotado'); return; }

        // cart item structure: { produtoId, nome, preco, img, quantidade }
        // we'll push under carrinhos/{cartId}/items/{produtoId}
        const itemRef = ref(db, `carrinhos/${cartId}/items/${key}`);
        // read current value by writing atomically with update: we will increment quantity client-side by reading current snapshot.
        // Simpler approach: fetch current via onValue once, but here use onValue once via promise:
        // we'll use a short onValue then off to get current quantity
        // For simplicity, try to set quantity = (existing + 1)
        onValue(itemRef, (s) => {
          const cur = s.exists() ? s.val() : null;
          const novaQ = cur ? (Number(cur.quantidade||0) + 1) : 1;
          set(itemRef, {
            produtoId: key,
            nome: p.nome,
            preco: p.preco,
            img: p.img || '',
            quantidade: novaQ
          }).then(()=> {
            showToast('Adicionado ao carrinho');
            // optionally decrement stock? keep stock management to admin or when finalizing order
          }).catch(err=> showToast('Erro: '+err.message));
        }, { onlyOnce: true });
      });

      const cartLink = document.createElement('a'); cartLink.href='carrinho.html'; cartLink.className='btn-cart-link'; cartLink.textContent='Ir ao Carrinho';

      card.appendChild(img); card.appendChild(h3); card.appendChild(price); card.appendChild(stock); card.appendChild(desc); card.appendChild(buy);
      grid.appendChild(card);
    });
  });
</script>
</body>
</html>
