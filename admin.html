<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Administração</title>

<style>
:root{--bg:linear-gradient(135deg,#00ff9d,#00b0ff)}
*{box-sizing:border-box}
body{margin:0;font-family:"Poppins",Arial,sans-serif;background:var(--bg);color:#022;min-height:100vh}
header{padding:28px;text-align:center;background:rgba(255,255,255,0.12);backdrop-filter:blur(6px);font-size:22px;font-weight:800}
.container{width:92%;max-width:1300px;margin:30px auto;display:grid;grid-template-columns:1fr 460px;gap:18px}
@media(max-width:1100px){.container{grid-template-columns:1fr}}
.panel{background:rgba(255,255,255,0.14);padding:16px;border-radius:12px;box-shadow:0 8px 30px #00000040}
h3{margin-top:0}
.produto-row{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.06);margin-bottom:10px}
.produto-row img{width:72px;height:72px;object-fit:cover;border-radius:8px}
.produto-info{flex:1}
.produto-actions{display:flex;gap:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-edit{background:#ffd400}
.btn-del{background:#ff6b6b;color:white}
.msg{background:rgba(255,255,255,0.06);padding:10px;border-radius:8px;margin-bottom:10px}
.small{font-size:13px;color:#033}
.count{display:inline-block;background:#fff;border-radius:999px;padding:6px 10px;font-weight:800;margin-left:8px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.export-btn{background:#111;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>

<header>⚙️ Painel Administrativo</header>

<div class="container">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Produtos (Controle de Estoque)</h3>
      <div class="toolbar">
        <button id="exportProdutos" class="export-btn">Exportar Produtos CSV</button>
      </div>
    </div>
    <div id="prodList"></div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Mensagens do SAC <span id="countMsg" class="count">0</span></h3>
    </div>
    <div id="sacList" style="margin-top:12px;max-height:25vh;overflow:auto"></div>

    <hr style="margin:12px 0;border:none;height:1px;background:rgba(0,0,0,0.06)">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Pedidos <span id="countPedidos" class="count">0</span></h3>
      <div class="toolbar">
        <button id="exportPedidos" class="export-btn">Exportar Pedidos CSV</button>
      </div>
    </div>
    <div id="pedList" style="margin-top:12px;max-height:45vh;overflow:auto"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA1jqtL0w3-g8lMMdzqG6EZXYjYaadjOpE",
    authDomain: "loja-final-c7af0.firebaseapp.com",
    databaseURL: "https://loja-final-c7af0-default-rtdb.firebaseio.com",
    projectId: "loja-final-c7af0",
    storageBucket: "loja-final-c7af0.firebasestorage.app",
    messagingSenderId: "895657253198",
    appId: "1:895657253198:web:c0ec7d4c31482f1c26e61f",
    measurementId: "G-BHB81J2JD4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const prodRef = ref(db, 'produtos');
  const sacRef = ref(db, 'sacMensagens');
  const pedidosRef = ref(db, 'pedidos');

  const prodList = document.getElementById('prodList');
  const sacList = document.getElementById('sacList');
  const pedList = document.getElementById('pedList');
  const countMsg = document.getElementById('countMsg');
  const countPedidos = document.getElementById('countPedidos');

  // Produtos
  onValue(prodRef, (snap) => {
    prodList.innerHTML = '';
    if (!snap.exists()) { prodList.innerHTML = '<div class="small">Nenhum produto cadastrado</div>'; return; }
    const data = snap.val();
    Object.entries(data).forEach(([key,p]) => {
      const row = document.createElement('div'); row.className='produto-row';
      const img = document.createElement('img'); img.src = p.img || 'https://via.placeholder.com/200?text=Sem+imagem';
      const info = document.createElement('div'); info.className='produto-info';
      info.innerHTML = `<strong>${p.nome}</strong><div class="small">R$ ${Number(p.preco).toFixed(2)} • Estoque: <span id="stk-${key}">${p.estoque||0}</span></div>`;
      const actions = document.createElement('div'); actions.className='produto-actions';
      const btnEdit = document.createElement('button'); btnEdit.className='btn btn-edit'; btnEdit.textContent='Editar estoque';
      btnEdit.addEventListener('click', () => {
        const novo = prompt('Novo estoque para "'+p.nome+'":', p.estoque || 0);
        if (novo === null) return;
        const novoNum = parseInt(novo);
        if (isNaN(novoNum)) { alert('Valor inválido'); return; }
        update(ref(db, 'produtos/' + key), { estoque: novoNum })
          .then(()=>{ document.getElementById('stk-'+key).textContent = novoNum; })
          .catch(err=>alert('Erro: '+err));
      });
      const btnDel = document.createElement('button'); btnDel.className='btn btn-del'; btnDel.textContent='Excluir';
      btnDel.addEventListener('click', () => {
        if (!confirm('Confirmar exclusão de "'+p.nome+'"?')) return;
        remove(ref(db, 'produtos/' + key)).catch(err=>alert('Erro: '+err));
      });
      actions.appendChild(btnEdit); actions.appendChild(btnDel);
      row.appendChild(img); row.appendChild(info); row.appendChild(actions);
      prodList.appendChild(row);
    });
  });

  // SAC
  onValue(sacRef, (snap) => {
    sacList.innerHTML = '';
    if (!snap.exists()) { sacList.innerHTML = '<div class="small">Nenhuma mensagem</div>'; countMsg.textContent = '0'; return; }
    const data = snap.val();
    const entries = Object.entries(data).reverse();
    countMsg.textContent = entries.length;
    entries.forEach(([key,m]) => {
      const div = document.createElement('div'); div.className='msg';
      div.innerHTML = `<strong>${m.tipo}</strong> — <small>${m.nome} • ${m.data||''}</small><div style="margin-top:6px">${m.descricao}</div>
        <div style="margin-top:8px"><button class="btn btn-del" data-key="${key}">Excluir</button></div>`;
      sacList.appendChild(div);
    });
    // delete handlers
    sacList.querySelectorAll('.btn-del').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const k = e.target.getAttribute('data-key');
        if (!confirm('Excluir mensagem?')) return;
        remove(ref(db, 'sacMensagens/' + k)).catch(err=>alert('Erro: '+err));
      });
    });
  });

  // Pedidos
  onValue(pedidosRef, (snap) => {
    pedList.innerHTML = '';
    if (!snap.exists()) { pedList.innerHTML = '<div class="small">Nenhum pedido</div>'; countPedidos.textContent = '0'; return; }
    const data = snap.val();
    const entries = Object.entries(data).reverse();
    countPedidos.textContent = entries.length;
    entries.forEach(([key,p]) => {
      const div = document.createElement('div'); div.className='msg';
      // show summary: buyer, total, createdAt, item count
      const itemCount = Object.keys(p.items || {}).length;
      div.innerHTML = `<strong>Pedido</strong> — <small>${p.buyer?.name || '—'} • ${new Date(p.createdAt).toLocaleString()}</small>
        <div style="margin-top:6px">Total: R$ ${Number(p.total||0).toFixed(2)} • Itens: ${itemCount}</div>
        <details style="margin-top:8px;padding-top:8px"><summary>Ver itens</summary>
          <div style="margin-top:8px">${Object.values(p.items || {}).map(i=>`<div><strong>${i.nome}</strong> x ${i.quantidade} — R$ ${Number(i.preco).toFixed(2)}</div>`).join('')}</div>
        </details>
        <div style="margin-top:8px"><button class="btn btn-del" data-key="${key}">Excluir Pedido</button></div>`;
      pedList.appendChild(div);
    });
    // delete handlers
    pedList.querySelectorAll('.btn-del').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const k = e.target.getAttribute('data-key');
        if (!confirm('Excluir pedido?')) return;
        remove(ref(db, 'pedidos/' + k)).catch(err=>alert('Erro: '+err));
      });
    });
  });

  // EXPORT CSV Helpers
  function downloadCSV(filename, rows) {
    if (!rows || !rows.length) { alert('Nada para exportar'); return; }
    const header = Object.keys(rows[0]);
    const csv = [header.join(',')].concat(rows.map(r => header.map(h => {
      let v = r[h] === undefined || r[h] === null ? '' : (''+r[h]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // export produtos
  document.getElementById('exportProdutos').addEventListener('click', () => {
    // read products once and export
    onValue(prodRef, (snap) => {
      if (!snap.exists()) { alert('Nenhum produto para exportar'); return; }
      const data = snap.val();
      const rows = Object.entries(data).map(([key,p]) => ({
        id: key,
        nome: p.nome || '',
        preco: Number(p.preco||0).toFixed(2),
        estoque: p.estoque||0,
        descricao: p.descricao||'',
        img: p.img||''
      }));
      downloadCSV('produtos_export.csv', rows);
    }, { onlyOnce: true });
  });

  // export pedidos
  document.getElementById('exportPedidos').addEventListener('click', () => {
    onValue(pedidosRef, (snap) => {
      if (!snap.exists()) { alert('Nenhum pedido para exportar'); return; }
      const data = snap.val();
      const rows = Object.entries(data).map(([key,p]) => {
        // flatten items to a compact string
        const itemsText = Object.values(p.items || {}).map(i => `${i.nome} x${i.quantidade}`).join(' | ');
        return {
          id: key,
          buyer_name: p.buyer?.name || '',
          buyer_contact: p.buyer?.contact || '',
          total: Number(p.total||0).toFixed(2),
          createdAt: p.createdAt || '',
          items: itemsText
        };
      });
      downloadCSV('pedidos_export.csv', rows);
    }, { onlyOnce: true });
  });

</script>
</body>
</html>
